@startuml Car Rental Cancellation Swimlane Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam handwritten false
skinparam defaultFontName Arial
skinparam defaultFontSize 12

title Car Rental Cancellation Flow - Drivon System

|Renter|
start
:Request rental cancellation;
note right
When rental is in ONGOING status
end note

|Frontend|
:Display cancellation form;
:Validate cancellation reason;
:POST /api/bookings/{bookingId}/request-cancel;

|Backend API|
:Validate rental exists;
:Check cancellation rights;
:Create CancelRequest;
note right
Status: PENDING
end note
:Notify car owner;

|Database|
:Create cancel_request record;
:Update rental status;
note right
Rental remains ONGOING
until owner confirms
cancellation
end note

|Car Owner|
:Receive notification;
:Review cancel request;
:Decide accept/reject;

|Frontend|
:Display cancel requests;
:Accept/Reject buttons;

|Backend API|
if (Accept cancellation?) then (yes)
  :PUT /api/bookings/{bookingId}/accept-cancel;
  :Update CancelRequest status;
  :Update Rental status;
  :Process refund;
  :Notify renter;
else (no)
  :PUT /api/bookings/{bookingId}/reject-cancel;
  :Update CancelRequest status;
  :Rental remains ONGOING;
  :Notify renter;
endif

|Database|
if (Accepted?) then (yes)
  :Update cancel_request status = ACCEPTED;
  :Update rental status = CANCELLED;
  :Create refund record;
else (no)
  :Update cancel_request status = REJECTED;
  :Rental status unchanged;
endif

|Payment Service|
if (Accepted?) then (yes)
  :Process refund payment;
  :Update payment status;
endif

|Email Service|
:Send cancellation notification;
:Send refund confirmation;

|Renter|
if (Accepted?) then (yes)
  :Receive cancellation confirmation;
  :Receive refund notification;
  :Rental officially cancelled;
else (no)
  :Receive rejection notification;
  :Rental continues;
endif
stop

legend right
|= |= |
|<#lightblue>|**Cancellation Cases:**|
| |Cancel before rental starts|
| |Cancel during rental period|
| |Cancel due to emergency|
|<#lightgreen>|**CancelRequest Status:**|
| |PENDING: Awaiting processing|
| |ACCEPTED: Cancellation approved|
| |REJECTED: Cancellation rejected|
|<#lightyellow>|**Refund Process:**|
| |Calculate refund amount|
| |Create refund record|
| |Update payment status|
endlegend

@enduml 